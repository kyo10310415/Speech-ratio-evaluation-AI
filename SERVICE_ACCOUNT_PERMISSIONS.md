# サービスアカウント権限に関する重要な説明

## ❗ 結論：サービスアカウントへの共有は**必須**です

開発者のGoogleアカウントが編集権限を持っていても、**サービスアカウントは別のアカウント**なので、個別に権限を付与する必要があります。

---

## 🤔 なぜサービスアカウントに権限が必要か？

### サービスアカウントの仕組み

```
開発者アカウント（あなた）
  ↓ プロジェクト作成
Google Cloud プロジェクト
  ↓ サービスアカウント作成
サービスアカウント（wannav-lesson-analyzer@...）← 別のアカウント！
```

- **開発者アカウント** = あなた個人のGoogleアカウント
- **サービスアカウント** = アプリケーション専用の機械的なアカウント

**両者は完全に別のアカウントです。**

プログラムが実行されるとき、**サービスアカウントとして**アクセスするため、開発者アカウントの権限は使われません。

---

## 📁 大量のフォルダへの権限付与を簡単にする方法

### 🎯 推奨方法：親フォルダに権限を付与

Googleドライブでは、**親フォルダに権限を付与すると、配下のすべてのサブフォルダに自動的に権限が継承**されます。

#### 手順

1. **すべての録画フォルダの親フォルダを特定**
   ```
   例:
   マイドライブ/
   └── WannaVレッスン録画/  ← この親フォルダに権限付与
       ├── 2024-01/
       │   ├── tutor_A/
       │   └── tutor_B/
       ├── 2024-02/
       │   ├── tutor_A/
       │   └── tutor_B/
       └── 2024-03/
           ├── tutor_A/
           └── tutor_B/
   ```

2. **親フォルダに一度だけ権限付与**
   - 「WannaVレッスン録画」フォルダを右クリック
   - 「共有」をクリック
   - サービスアカウントのメール（`wannav-lesson-analyzer@...`）を追加
   - 権限: **「閲覧者」**
   - 「送信」

3. **✅ 完了！**
   - 配下のすべてのサブフォルダに自動的に権限が継承されます
   - 新しく作成されるフォルダにも自動的に権限が適用されます

---

## 🔄 フォルダ構造の整理（推奨）

### 現状の問題
```
シート1のC列:
https://drive.google.com/drive/folders/ABC123  ← tutor_A フォルダ
https://drive.google.com/drive/folders/DEF456  ← tutor_B フォルダ
https://drive.google.com/drive/folders/GHI789  ← tutor_C フォルダ
...
```
→ 各フォルダに個別に権限付与が必要（大変）

### 推奨構造
```
親フォルダ（1回だけ権限付与）
└── 各講師のフォルダ
    └── 録画ファイル
```

#### オプション1: 既存のフォルダ構造を活用

既存のフォルダがすでに階層構造になっている場合：

1. 最上位の親フォルダを見つける
2. その親フォルダのURLを確認
3. 親フォルダに権限付与（1回だけ）
4. **シート1のC列はそのまま**（個別フォルダURLを維持）

これで、個別フォルダへのアクセスも親フォルダの権限で可能になります。

#### オプション2: 新しい共有フォルダを作成

完全にコントロールしたい場合：

1. **新しい親フォルダを作成**
   ```
   名前: WannaVレッスン録画_共有用
   ```

2. **既存の講師フォルダを移動またはショートカット作成**
   - 移動: ドラッグ&ドロップで親フォルダに移動
   - ショートカット: 右クリック → 「ドライブにショートカットを追加」

3. **親フォルダに権限付与**
   - サービスアカウントを「閲覧者」として追加

4. **シート1のC列を更新**（オプション）
   - 新しい親フォルダのURLに統一
   - または、既存のURLのままでもOK（権限は継承される）

---

## 🔧 実装上の工夫

### 方法1: 親フォルダURLを環境変数化

すべての録画が1つの親フォルダ配下にある場合：

1. **親フォルダに権限付与**

2. **シート1の構造を変更**
   - C列: 講師名（tutorフォルダ名）
   - 親フォルダURLは環境変数で管理

```
シート1:
A      B         C           D
ID    日付     講師名   tutor_name
1   2024-01   tutor_A   山田太郎
2   2024-01   tutor_B   田中花子
```

3. **コード側で親フォルダURL + 講師名でパス構築**
   ```javascript
   const parentFolderId = 'ABC123'; // 環境変数
   const tutorFolderName = 'tutor_A'; // シートから取得
   // parentFolder配下のtutorフォルダを検索
   ```

### 方法2: 現状維持（個別URL）+ 親フォルダ権限

1. **親フォルダに権限付与**（1回だけ）

2. **シート1のC列はそのまま**（個別フォルダURL）

3. **コードはそのまま**
   - 個別フォルダURLから直接アクセス
   - 親フォルダの権限が継承されているため動作する

これが**最も簡単な方法**です！

---

## ✅ 推奨手順（最小限の作業）

### ステップ1: フォルダ構造を確認

1. シート1のC列にあるフォルダURLを数個開く
2. すべてのフォルダに共通の親フォルダがあるか確認
   - 例: 「マイドライブ/WannaV録画/」など

### ステップ2: 親フォルダに権限付与

1. 共通の親フォルダを開く
2. 右クリック → 「共有」
3. サービスアカウントのメールを追加
4. 権限: **「閲覧者」**
5. 「送信」

### ステップ3: 動作確認

1. Renderまたはローカルで `npm run validate` 実行
2. Google Sheetsへのアクセスを確認
3. `npm run daily` で日次ジョブをテスト実行
4. ログでDriveアクセスが成功しているか確認

### ステップ4: 完了！

- ✅ 1回の権限付与で完了
- ✅ 今後新しいフォルダが追加されても自動で権限継承
- ✅ シート1の変更不要

---

## 🚨 権限継承の注意点

### 継承される場合
- ✅ 親フォルダに権限を付与 → 配下の**すべてのサブフォルダとファイル**に継承

### 継承されない場合
- ❌ 個別に「共有を無効化」したフォルダ
- ❌ 別のGoogleアカウントから共有されたフォルダ（共有されただけのもの）

### 確認方法

個別フォルダを開いて「共有」をクリック:
```
閲覧者:
- 開発者アカウント（あなた）
- wannav-lesson-analyzer@... ← これが表示されていればOK
  ※「継承された権限」として表示される
```

---

## 📋 チェックリスト

### 最小限の作業（推奨）

- [ ] すべての録画フォルダに共通の親フォルダを特定
- [ ] 親フォルダにサービスアカウントを「閲覧者」として追加
- [ ] Google Sheets にサービスアカウントを「編集者」として追加
- [ ] 動作確認（`npm run validate` → `npm run daily`）

### 個別フォルダに権限付与する場合（非推奨）

- [ ] シート1のC列のフォルダURLをすべて取得
- [ ] 各フォルダを開いて個別に権限付与...（大変）

---

## 🎯 まとめ

### Q: サービスアカウントへの共有は必要？
**A: はい、必須です。**

開発者アカウントとサービスアカウントは別のアカウントなので、プログラムからアクセスするにはサービスアカウントに権限が必要です。

### Q: 大量のフォルダに1つずつ共有するのは大変
**A: 親フォルダに1回だけ権限付与すればOKです！**

親フォルダに権限を付与すると、配下のすべてのサブフォルダとファイルに自動的に継承されます。

### 最も簡単な方法

1. ✅ すべての録画フォルダの親フォルダを特定
2. ✅ 親フォルダにサービスアカウントを「閲覧者」として追加（1回だけ）
3. ✅ Google Sheets にサービスアカウントを「編集者」として追加（1回だけ）
4. ✅ 完了！

**これで、シート1のC列に記載された個別フォルダすべてにアクセス可能になります。**

---

## 💡 補足：権限のトラブルシューティング

### テスト方法

以下のコマンドでDriveアクセスをテスト:

```bash
# 環境変数確認
npm run validate

# 日次ジョブ実行（前日分）
npm run daily
```

### エラーが出た場合

#### "Permission denied" エラー
→ サービスアカウントに権限が付与されていない

**解決策**:
1. 親フォルダの「共有」設定を確認
2. サービスアカウントのメールが「閲覧者」として表示されているか確認
3. 表示されていない場合は追加

#### "File not found" エラー
→ フォルダURLが間違っているか、フォルダが削除された

**解決策**:
1. シート1のC列のURLをブラウザで開いて確認
2. URLが正しいか確認

---

これで大量のフォルダへの権限付与が1回で完了します！
