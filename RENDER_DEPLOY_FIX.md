# Render デプロイ手順 - 月次サマリー修正版

## 修正内容サマリー

✅ **コストゼロ**: 月次ジョブの再実行不要  
✅ **データ保持**: 既存のデータをそのまま使用  
✅ **表示のみ修正**: APIとフロントエンドを実際のヘッダーに合わせる

---

## 修正したファイル

### 1. `src/dashboard/server.js`
**変更内容**:
- API `/api/monthly-summary` のフィールド名を実際のヘッダーに合わせた
- テーブルヘッダーに説明用のツールチップを追加

**変更箇所**:
```javascript
// 旧
avg_tutor_talk_ratio: parseFloat(row[headers.indexOf('avg_tutor_talk_ratio')] || 0)
avg_silence_15s_count: parseFloat(row[headers.indexOf('avg_silence_15s_count')] || 0)
total_duration_min: parseFloat(row[headers.indexOf('total_duration_min')] || 0)

// 新
avg_talk_ratio: parseFloat(row[headers.indexOf('avg_talk_ratio_tutor')] || 0)
avg_monologue_sec: parseFloat(row[headers.indexOf('avg_max_tutor_monologue_sec')] || 0)
avg_confusion_ratio: parseFloat(row[headers.indexOf('avg_confusion_ratio_est')] || 0)
```

### 2. `public/static/js/dashboard.js`
**変更内容**:
- チャートとテーブルのフィールド名を新しいAPIレスポンスに合わせた
- 各指標に色分けロジックを追加（緑/黄/赤）
- 単位を追加（%, 秒）

**変更箇所**:
- チャートデータ: `avg_tutor_talk_ratio` → `avg_talk_ratio`
- テーブル表示: 3つの新しい指標に対応

---

## 表示される指標

| 指標 | 元データ | 表示形式 | 良好な範囲 | 色分け |
|------|---------|---------|-----------|--------|
| 平均発話比率 | `avg_talk_ratio_tutor` | XX.X% | ≤60% | 緑:≤60%, 黄:≤70%, 赤:>70% |
| 平均モノローグ時間 | `avg_max_tutor_monologue_sec` | XX秒 | ≤60秒 | 緑:≤60秒, 黄:≤120秒, 赤:>120秒 |
| 平均混乱率 | `avg_confusion_ratio_est` | XX.X% | ≤20% | 緑:≤20%, 黄:≤40%, 赤:>40% |

---

## Render での確認手順

### ステップ1: 自動デプロイを確認

1. https://dashboard.render.com/ にログイン
2. `wannav-lesson-analyzer` サービスを選択
3. **Events** タブで最新のデプロイ状況を確認

期待されるメッセージ:
```
Building...
Deploy live
```

### ステップ2: ダッシュボードを確認

https://speech-ratio-evaluation-ai.onrender.com にアクセス

**月次サマリーテーブル**で以下を確認:

| 月 | 講師 | レッスン数 | 平均発話比率 ℹ️ | 平均モノローグ時間 ℹ️ | 平均混乱率 ℹ️ |
|----|------|-----------|----------------|-------------------|--------------|
| | りょうや先生 | 2 | **40.6%** | **60秒** | **30.0%** |
| | まり先生 | 2 | **80.6%** | **53秒** | **25.0%** |

✅ 確認ポイント:
- 平均発話比率が 40.6%, 80.6% など正しい値
- 平均モノローグ時間が 60秒, 53秒 など正しい値
- 平均混乱率が 30.0%, 25.0% など正しい値
- 各ヘッダーに ℹ️ アイコンがあり、ホバーで説明が表示される

### ステップ3: チャートを確認

**講師発話比率 推移** チャートで:
- データが正しくプロットされている
- Y軸が 0-100% の範囲
- 各講師の線が表示される

---

## トラブルシューティング

### Q1: まだ0が表示される

**原因**: ブラウザキャッシュ

**解決策**:
```
1. Ctrl + Shift + R (強制リロード)
2. または、ブラウザのキャッシュをクリア
```

### Q2: デプロイが完了しない

**原因**: Renderのビルドキャッシュ

**解決策**:
```
1. Render Dashboard → Manual Deploy
2. "Clear build cache & deploy" を選択
```

### Q3: APIエラーが表示される

**原因**: サーバーが再起動していない

**解決策**:
Render Shellで:
```bash
cd /opt/render/project/src
pm2 restart all
```

---

## 追加の改善点

### ツールチップの説明

ヘッダーにマウスをホバーすると表示される説明:

1. **平均発話比率**: 講師の発話時間 / 全体時間
2. **平均モノローグ時間**: 講師が連続して話した最長時間（秒）
3. **平均混乱率**: 生徒が混乱している可能性の割合

### 色分けロジック

各指標が視覚的に分かりやすくなりました:
- 🟢 緑: 良好
- 🟡 黄: 注意
- 🔴 赤: 改善が必要

---

## まとめ

### ✅ 完了した作業
1. APIのフィールド名を実際のヘッダーに合わせた
2. テーブル表示を3つの新しい指標に変更
3. 各指標に色分けと単位を追加
4. ツールチップで説明を追加

### 💰 コスト
- **$0**: 月次ジョブの再実行不要
- **$0**: データの再取得不要
- **時間**: デプロイ時間のみ（約5分）

### 📊 期待される結果
- 平均発話比率: 40.6%, 80.6% など正しい値が表示
- 平均モノローグ時間: 60秒, 53秒 など正しい値が表示
- 平均混乱率: 30.0%, 25.0% など正しい値が表示
- すべての値が0でなくなる

---

**作成日**: 2026-01-17  
**バージョン**: v3.0.3  
**ステータス**: Render 自動デプロイ待ち
